import re
import pytest
from typing import Dict

from fastapi.testclient import TestClient
from sqlalchemy.orm import Session


BASE_URL = "http://localhost:5000"

MOCK_USERS = {
    "new_user": {
        "email": "student1@example.com",
        "password": "1234",
        "name": "학생1",
        "std_no": "2217",
        "gender": 1,
    },
    "exist_user": {
        "email": "exist@example.com",
        "password": "1234",
        "name": "있던학생",
        "std_no": "2116",
        "gender": 1,
    },
}


def test_get_user_by_token(client: TestClient, token_headers: Dict[str, str]) -> None:
    response = client.get(f"{BASE_URL}/user", headers=token_headers)

    exist_user_data = MOCK_USERS["exist_user"].copy()
    del exist_user_data["password"]

    assert response.json() == MOCK_USERS["exist_user"]


def test_create_new_user(client: TestClient) -> None:
    data = MOCK_USERS["new_user"]
    response = client.post(f"{BASE_URL}/user/register", json=data)

    assert 201 == response.status_code


def test_create_existing_user(client: TestClient) -> None:
    data = MOCK_USERS["exist_user"]
    response = client.post(f"{BASE_URL}/user/register", json=data)

    assert 400 == response.status_code


def test_new_email_check(client: TestClient) -> None:
    data = {"email": MOCK_USERS["new_user"]["email"]}
    response = client.post(f"{BASE_URL}/user/email-check", json=data)

    assert 200 == response.status_code


def test_existing_email_check(client: TestClient) -> None:
    data = {"email": MOCK_USERS["exist_user"]["email"]}
    response = client.post(f"{BASE_URL}/user/email-check", json=data)

    assert 400 == response.status_code


def test_login_user(client: TestClient) -> None:
    data = {
        "email": MOCK_USERS["exist_user"]["email"],
        "password": MOCK_USERS["exist_user"]["password"],
    }
    response = client.post(f"{BASE_URL}/login/", json=data)
    assert 200 == response.status_code
    token_regular = re.compile(".[.].[.]")
    assert token_regular.match(response.json()["token"])


def test_login_user_by_access_token(
    client: TestClient, token_headers: Dict[str, str]
) -> None:
    response = client.get(f"{BASE_URL}/user/access-token", headers=token_headers)

    assert response.status_code == 200


def test_modify_user(client: TestClient, token_headers: Dict[str, str]) -> None:
    data = {
        "name": "정현문",
        "stdNo": 3116,
        "sex": "male",
        "image": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAMFBMVEXFxcX////CwsLGxsb7+/vT09PJycn19fXq6urb29ve3t7w8PDOzs7n5+f5+fnt7e30nlkBAAAFHUlEQVR4nO2dC5qqMAyFMTwUBdz/bq+VYYrKKJCkOfXmXwHna5uTpA+KwnEcx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3EcA2iO9cdIc5PUdO257y+BU39u66b4HplE3fk6VIcnqmNfl1+gksr6+iIucjl3WYukor7+re6Hoe1y1UhNO3zUd+fUFRmKpOa0Tt6dY5ubRCrOG/QFLk1WGmnt/JxzykcjdZ/jyxJDLlOV2l36AtcsJJb9boG3YcR3DuqODIE3ztYKPkDdmwRmpUToUaSaq++AvRgZMWbOpbQW8hdCAm8ZDugoikzREdCJ2okJPBx6azFLNOwoOgcxojJ98JkaTSJxMpklKrCAKhZGI0drTY/wU5lXoJYibannV9NYy4oozNEAkPHTjop+DTDxVGkIgYJNoyQQJtiIW+EMjGAjm649AjGIaqswcEFQKJ2QPlJbqytki6ZXAAZRJ52J2McaUowzAfs+uFzrYhnzaapphiPWdaJWShqxjqa6kTTQ205TVbsfMa6htL0iYOsXpJrQjHSmCkv1QGPtiHqlYcQ21Gj7fcDU8xOEUuNgSltPzexh+HqFlanCBHZ4OLhCV+gK/3OF6vWvucLv98MUOY2pwu/PS/+D2qJU7pYGbOvDFDW+bbON9p3o3oRxn0bfLgZTgSn6pSfrtr56qLHemtHPTK2319SzGvtjQ9qeb39WgS66Cm073nd0U1PzDdJCO3Gzn6TKpl9Zq7ujGWsQhlA3NwWIMwG9zM08Y/tBrR9VWeczv5CSQuuUNKIUTk23ZJ5RKfVhjnkXotfWIlgX2BSCDYbZR+QTcLhb3dKZDUY2M0d4KWItwhHRah/zsrOgKw4wycwjcgEVcgQDQo23CqSiWEJkFAfod2oE1uIFdA1OsCPqFXYNTjCfb8Ez+iX2x5sKLlVbhtqdDcar9ZevhnbZxoBUD35k23t0d304LYs1ELVbnfFaZ/REJJX9niP8Q19moZGo3m8XR/yBvOnjFfsXcI2c8ZuNo7WMP5HQh6yRGrlmFOJTnyTcT+zRlqPUBI2gTVWNUzUna1ERgecgF4GpNBQ38jGqxVLzQA1A31Rrhk6Yz9QEh/WND0GnuG9huhiTXJkxfAizTHLr6cbJKN6UCU6x/2DTRE1xEeEXi3O0ZUqBN4nJRzHhFB1JPlFTBZlI2kQ8zc3KJ1Le8DIRmFJiknuVS6RK4Ej/JtBfJErDSzOBiY4wJHX6Z1I4v1GUmdCPNirnLLeg3oJLcbX5PcpHNbRvOa1A956QmRPOUXVF+zkaUJynpkYR0bOMJH2nNej1pqyV/aKkz9jr5yj5vrXXz1F5SQLACiMapmierj2ikLyleKdlA/I/2oFxiglxx9B+mHwz0lf34IZQfhDRhlD6bhvgEAoPYooHkTczSIZTLC+cEExsoNKZiGBiY9cCfo/Y/SjIOBMQizWWTe73CMUasJx7jlD+DdKdWUKoY4PRYFtGpO0G1Lx4RaadgTtJhf4fiGqGIwKWCGuGIwKWqP+7IxYCzygjR9IAO5pC7Da9g70TBVpWRNgFBlgT8RV2WxHbKwJMv4BOaEaYaU2K16yZMN/qgV+G7IWIvwyZCxHeDQMsR8wg0DBDDXB5H2EV+hkEGmaoySHQsEJNFoGGFWrAq98JRhUMX1iMMMqLLEIpK5jCbd4vw9nSt/72lewXiN6jmdjfq8Hdknlk92ZwJnbIMMRM7JBhiFlUFoHd1UWaP1QKsPsHA5mkNB+Smn9JqV3wskatnQAAAABJRU5ErkJggg==",
    }
    response = client.put(f"{BASE_URL}/user", headers=token_headers, json=data)

    assert response.status_code == 200


def test_delete_user(client: TestClient, token_headers: Dict[str, str]) -> None:
    response = client.delete(f"{BASE_URL}/user", headers=token_headers)

    assert response.status_code == 204
